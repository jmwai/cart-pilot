name: Deploy to Cloud Run

on:
  push:
    branches:
      - main
    paths:
      - 'frontend/**'
      - 'backend/**'

jobs:
  check-changes:
    name: Check Changed Files
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.filter.outputs.backend }}
      frontend: ${{ steps.filter.outputs.frontend }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            backend:
              - 'backend/**'
            frontend:
              - 'frontend/**'

  deploy-backend:
    name: Deploy Backend Service
    runs-on: ubuntu-latest
    needs: check-changes
    if: needs.check-changes.outputs.backend == 'true'
    
    permissions:
      contents: read
      id-token: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}
    
    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
      with:
        project_id: ${{ secrets.PROJECT_ID }}
    
    - name: Configure Docker for GCR
      run: |
        gcloud auth configure-docker europe-west1-docker.pkg.dev --quiet
    
    - name: Build Docker image
      working-directory: ./backend
      run: |
        IMAGE_NAME="europe-west1-docker.pkg.dev/${{ secrets.PROJECT_ID }}/cloud-run-agent/backend-service"
        IMAGE_TAG="${IMAGE_NAME}:${GITHUB_SHA}"
        IMAGE_LATEST="${IMAGE_NAME}:latest"
        
        docker build -t $IMAGE_TAG -t $IMAGE_LATEST .
        echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV
        echo "IMAGE_LATEST=$IMAGE_LATEST" >> $GITHUB_ENV
    
    - name: Push Docker image to Artifact Registry
      run: |
        docker push ${{ env.IMAGE_TAG }}
        docker push ${{ env.IMAGE_LATEST }}
    
    - name: Deploy to Cloud Run
      run: |
        gcloud run deploy backend-service \
          --image ${{ env.IMAGE_TAG }} \
          --region europe-west1 \
          --platform managed \
          --allow-unauthenticated \
          --set-env-vars="PROJECT_ID=${{ secrets.PROJECT_ID }},REGION=europe-west1,GOOGLE_API_KEY=${{ secrets.GOOGLE_API_KEY }}" \
          --port 8080 \
          --memory 512Mi \
          --cpu 1 \
          --timeout 300 \
          --max-instances 10 \
          --min-instances 0

  deploy-frontend:
    name: Deploy Frontend Service
    runs-on: ubuntu-latest
    needs: check-changes
    if: needs.check-changes.outputs.frontend == 'true'
    
    permissions:
      contents: read
      id-token: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}
    
    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
      with:
        project_id: ${{ secrets.PROJECT_ID }}
    
    - name: Configure Docker for GCR
      run: |
        gcloud auth configure-docker europe-west1-docker.pkg.dev --quiet
    
    - name: Get backend service URL
      id: backend-url
      run: |
        BACKEND_URL=$(gcloud run services describe backend-service \
          --region europe-west1 \
          --project ${{ secrets.PROJECT_ID }} \
          --format 'value(status.url)' \
          --quiet || echo "")
        echo "BACKEND_URL=$BACKEND_URL" >> $GITHUB_ENV
        echo "BACKEND_URL=$BACKEND_URL"
    
    - name: Build Docker image
      working-directory: ./frontend
      run: |
        IMAGE_NAME="europe-west1-docker.pkg.dev/${{ secrets.PROJECT_ID }}/cloud-run-agent/frontend-service"
        IMAGE_TAG="${IMAGE_NAME}:${GITHUB_SHA}"
        IMAGE_LATEST="${IMAGE_NAME}:latest"
        
        # Build args for environment variables
        docker build \
          --build-arg NEXT_PUBLIC_AGENT_CARD_URL="${{ env.BACKEND_URL }}/.well-known/agent-card.json" \
          --build-arg NEXT_PUBLIC_API_BASE_URL="${{ env.BACKEND_URL }}" \
          --build-arg NEXT_PUBLIC_DEFAULT_USER_ID="user_guest" \
          -t $IMAGE_TAG \
          -t $IMAGE_LATEST .
        echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV
        echo "IMAGE_LATEST=$IMAGE_LATEST" >> $GITHUB_ENV
    
    - name: Push Docker image to Artifact Registry
      run: |
        docker push ${{ env.IMAGE_TAG }}
        docker push ${{ env.IMAGE_LATEST }}
    
    - name: Deploy to Cloud Run
      run: |
        gcloud run deploy frontend-service \
          --image ${{ env.IMAGE_TAG }} \
          --region europe-west1 \
          --platform managed \
          --allow-unauthenticated \
          --port 8080 \
          --memory 512Mi \
          --cpu 1 \
          --timeout 300 \
          --max-instances 10 \
          --min-instances 0


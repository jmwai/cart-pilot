name: Deploy to Cloud Run

on:
  push:
    branches:
      - main
    paths:
      - 'frontend/**'
      - 'backend/**'

jobs:
  check-changes:
    name: Check Changed Files
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.filter.outputs.backend }}
      frontend: ${{ steps.filter.outputs.frontend }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            backend:
              - 'backend/**'
            frontend:
              - 'frontend/**'

  deploy-backend:
    name: Deploy Backend Service
    runs-on: ubuntu-latest
    needs: check-changes
    if: needs.check-changes.outputs.backend == 'true'
    
    permissions:
      contents: read
      id-token: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}
    
    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
      with:
        project_id: ${{ secrets.PROJECT_ID }}
    
    - name: Configure Docker for GCR
      run: |
        gcloud auth configure-docker europe-west1-docker.pkg.dev --quiet
    
    - name: Build Docker image
      working-directory: ./backend
      run: |
        IMAGE_NAME="europe-west1-docker.pkg.dev/${{ secrets.PROJECT_ID }}/cart-pilot/cart-pilot-backend"
        IMAGE_TAG="${IMAGE_NAME}:${GITHUB_SHA}"
        
        docker build -t $IMAGE_TAG .
        echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV
    
    - name: Push Docker image to Artifact Registry
      run: |
        docker push ${{ env.IMAGE_TAG }}
    
    - name: Deploy to Cloud Run
      uses: google-github-actions/deploy-cloudrun@v3
      with:
        service: cart-pilot-backend
        image: ${{ env.IMAGE_TAG }}
        region: europe-west1
        project_id: ${{ secrets.PROJECT_ID }}
        timeout: 300s
        env_vars_update_strategy: overwrite
        # flags: '--allow-unauthenticated --port=8080 --memory=512Mi --cpu=1 --max-instances=3 --min-instances=0'
        env_vars: |
          PROJECT_ID=${{ secrets.PROJECT_ID }}
          REGION=europe-west1
        secrets: |
          GOOGLE_API_KEY=${{ secrets.GOOGLE_API_KEY }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          DB_HOST=${{ secrets.DB_HOST }}
          DB_NAME=${{ secrets.DB_NAME }}
          DB_USER=${{ secrets.DB_USER }}
        flags: >-
          --allow-unauthenticated
          --port=8080
          --memory=512Mi
          --cpu=1
          --max-instances=3
          --min-instances=0
          --service-account=${{ secrets.GCP_SERVICE_ACCOUNT }}

  deploy-frontend:
    name: Deploy Frontend Service
    runs-on: ubuntu-latest
    needs: check-changes
    if: needs.check-changes.outputs.frontend == 'true'
    
    permissions:
      contents: read
      id-token: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}
    
    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
      with:
        project_id: ${{ secrets.PROJECT_ID }}
    
    - name: Configure Docker for GCR
      run: |
        gcloud auth configure-docker europe-west1-docker.pkg.dev --quiet
    
    - name: Get backend service URL
      id: backend-url
      run: |
        BACKEND_URL=$(gcloud run services describe cart-pilot-backend \
          --region europe-west1 \
          --project ${{ secrets.PROJECT_ID }} \
          --format 'value(status.url)' \
          --quiet || echo "")
        echo "BACKEND_URL=$BACKEND_URL" >> $GITHUB_ENV
        echo "BACKEND_URL=$BACKEND_URL"
    
    - name: Build Docker image
      working-directory: ./frontend
      run: |
        IMAGE_NAME="europe-west1-docker.pkg.dev/${{ secrets.PROJECT_ID }}/cart-pilot/cart-pilot-frontend"
        IMAGE_TAG="${IMAGE_NAME}:${GITHUB_SHA}"
        
        # Build args for environment variables
        docker build \
          --build-arg NEXT_PUBLIC_AGENT_CARD_URL="${{ env.BACKEND_URL }}/.well-known/agent-card.json" \
          --build-arg NEXT_PUBLIC_API_BASE_URL="${{ env.BACKEND_URL }}" \
          --build-arg NEXT_PUBLIC_DEFAULT_USER_ID="user_guest" \
          -t $IMAGE_TAG .
        echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV
    
    - name: Push Docker image to Artifact Registry
      run: |
        docker push ${{ env.IMAGE_TAG }}
    
    - name: Deploy to Cloud Run
      uses: google-github-actions/deploy-cloudrun@v3
      with:
        service: cart-pilot-frontend
        image: ${{ env.IMAGE_TAG }}
        region: europe-west1
        project_id: ${{ secrets.PROJECT_ID }}
        timeout: 300s
        flags: '--allow-unauthenticated --port=8080 --memory=512Mi --cpu=1 --max-instances=3 --min-instances=0'


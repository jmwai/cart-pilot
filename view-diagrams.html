<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Architecture Diagrams - Cart Pilot</title>
    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
        mermaid.initialize({ 
            startOnLoad: true,
            theme: 'default',
            securityLevel: 'loose',
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true,
                curve: 'basis'
            },
            sequence: {
                diagramMarginX: 50,
                diagramMarginY: 10,
                actorMargin: 50,
                width: 150,
                height: 65,
                boxMargin: 10,
                boxTextMargin: 5,
                noteMargin: 10,
                messageMargin: 35,
                mirrorActors: true,
                bottomMargin: 50,
                leftMargin: 75,
                rightMargin: 75,
                topMargin: 75
            }
        });
    </script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        h1 {
            color: #333;
            border-bottom: 3px solid #1976d2;
            padding-bottom: 10px;
        }
        h2 {
            color: #555;
            margin-top: 40px;
            border-bottom: 2px solid #42a5f5;
            padding-bottom: 8px;
        }
        .diagram-container {
            background: white;
            border-radius: 8px;
            padding: 30px;
            margin: 30px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow-x: auto;
        }
        .mermaid {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 400px;
        }
        .description {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            border-left: 4px solid #1976d2;
        }
        .toc {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .toc ul {
            list-style: none;
            padding-left: 0;
        }
        .toc li {
            margin: 10px 0;
        }
        .toc a {
            color: #1976d2;
            text-decoration: none;
            font-weight: 500;
        }
        .toc a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <h1>üèóÔ∏è Cart Pilot - Architecture Diagrams</h1>
    
    <div class="toc">
        <h2>üìë Table of Contents</h2>
        <ul>
            <li><a href="#adk-runtime">ADK Runtime Architecture (Google Cloud)</a></li>
            <li><a href="#gcp-infrastructure">Google Cloud Infrastructure Architecture</a></li>
            <li><a href="#cicd-flow">CI/CD Deployment Flow</a></li>
            <li><a href="#request-flow">Request Flow Through Google Cloud</a></li>
            <li><a href="#application-architecture">Application Architecture</a></li>
            <li><a href="#user-journey">User Journey Flow</a></li>
        </ul>
    </div>

    <h2 id="adk-runtime">ADK Runtime Architecture (Google Cloud)</h2>
    <div class="description">
        Architecture diagram showing the Agent Development Kit Runtime structure with Frontend and Backend services running in Cloud Run.
    </div>
    <div class="diagram-container">
        <div class="mermaid">
graph TB
    %% User
    User[üë§ User]
    
    %% Cloud Run Services
    subgraph CloudRun["Google Cloud Run (europe-west1)"]
        direction TB
        
        %% Frontend Service
        subgraph FrontendService["Frontend Service: cart-pilot-frontend"]
            FrontendApp[Frontend Application<br/>Next.js UI<br/>A2A Client SDK]
        end
        
        %% Backend Service
        subgraph BackendService["Backend Service: cart-pilot-backend"]
            direction TB
            
            %% ADK Runtime (dashed box)
            subgraph ADKRuntime["Agent Development Kit Runtime"]
                direction TB
                
                Runner[Runner<br/>Event Processor<br/>ShoppingAgentExecutor]
                EventLoop[2. Event Loop<br/>Ask ‚Üî Yield]
                ExecutionLogic[Execution Logic<br/>Shopping Agent<br/>Sub-Agents<br/>LLM Innovation<br/>Callbacks<br/>Tools]
            end
            
            Services[Services<br/>Session Service<br/>Artifact Service<br/>Memory Service]
        end
    end
    
    %% External Services
    subgraph ExternalServices["External Services"]
        Storage[(Storage<br/>Cloud SQL<br/>PostgreSQL + pgvector)]
        VertexAI[Vertex AI<br/>Gemini 2.5 Flash<br/>Multimodal Embeddings]
    end
    
    %% Flow 1: User Request
    User -->|1. User: Help me to do...?<br/>session_id: 's_123'| FrontendApp
    
    %% Flow: Frontend to Backend
    FrontendApp -->|A2A Protocol Request| Runner
    
    %% Flow 2: Event Loop
    Runner -->|Ask| EventLoop
    EventLoop -->|Yield| Runner
    
    %% Flow 3: Stream Events
    Runner -->|3. Stream&lt;Event&gt;| FrontendApp
    FrontendApp -->|Stream&lt;Event&gt;| User
    
    %% Execution Logic to Vertex AI
    ExecutionLogic -->|LLM API Calls| VertexAI
    VertexAI -->|LLM Responses| ExecutionLogic
    
    %% Services interactions (dashed)
    Runner -.->|Uses| Services
    Services -.->|Persists/Retrieves| Storage
    
    %% Execution Logic uses Services
    ExecutionLogic -.->|Accesses| Services
    
    %% Styling
    classDef user fill:#e3f2fd,stroke:#1976d2,stroke-width:3px
    classDef frontend fill:#e1f5ff,stroke:#01579b,stroke-width:2px
    classDef backend fill:#fff3e0,stroke:#e65100,stroke-width:2px
    classDef adk fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
    classDef services fill:#e8f5e9,stroke:#1b5e20,stroke-width:2px
    classDef storage fill:#fce4ec,stroke:#880e4f,stroke-width:2px
    classDef vertex fill:#fff9c4,stroke:#f57f17,stroke-width:2px
    
    class User user
    class FrontendApp,FrontendService frontend
    class Runner,EventLoop,ExecutionLogic,BackendService backend
    class ADKRuntime adk
    class Services services
    class Storage storage
    class VertexAI vertex
    
    %% Make ADK Runtime box dashed
    style ADKRuntime stroke-dasharray: 8 4
    style FrontendService stroke-dasharray: 4 2
    style BackendService stroke-dasharray: 4 2
        </div>
    </div>

    <h2 id="gcp-infrastructure">Google Cloud Infrastructure Architecture</h2>
    <div class="description">
        Complete Google Cloud Platform infrastructure showing all services, networking, security, and deployment components.
    </div>
    <div class="diagram-container">
        <div class="mermaid">
graph TB
    %% External Users
    subgraph External["External"]
        Users[Users/Browsers]
        GitHub[GitHub Repository]
    end

    %% CI/CD Pipeline
    subgraph CICD["CI/CD Pipeline (GitHub Actions)"]
        GitHubActions[GitHub Actions Workflow]
        BuildBackend[Build Backend Image]
        BuildFrontend[Build Frontend Image]
        PushImages[Push to Artifact Registry]
    end

    %% Google Cloud Project
    subgraph GCP["Google Cloud Project: gemini-adk-vertex-2025"]
        
        %% Artifact Registry
        subgraph ArtifactRegistry["Artifact Registry (europe-west1)"]
            ARRepo[cart-pilot Repository]
            BackendImage[cart-pilot-backend<br/>Docker Image]
            FrontendImage[cart-pilot-frontend<br/>Docker Image]
        end

        %% Secret Manager
        subgraph SecretManager["Secret Manager"]
            APIKeySecret[google-api-key]
            DBPasswordSecret[db-password]
            DBNameSecret[db-name]
            DBUserSecret[db-user]
            CloudSQLSecret[cloud-sql-connection-name]
        end

        %% Cloud Run Services
        subgraph CloudRun["Cloud Run (europe-west1)"]
            subgraph BackendService["Backend Service: cart-pilot-backend"]
                BackendContainer[Backend Container<br/>FastAPI + ADK<br/>Port: 8080<br/>Memory: 512Mi<br/>CPU: 1<br/>Min: 1, Max: 3]
                BackendEnv[Environment Variables<br/>PROJECT_ID<br/>REGION]
                BackendSecrets[Secrets<br/>GOOGLE_API_KEY<br/>DB_PASSWORD<br/>DB_NAME<br/>DB_USER<br/>CLOUD_SQL_CONNECTION_NAME]
            end
            
            subgraph FrontendService["Frontend Service: cart-pilot-frontend"]
                FrontendContainer[Frontend Container<br/>Next.js Standalone<br/>Port: 8080<br/>Memory: 512Mi<br/>CPU: 1<br/>Min: 1, Max: 3]
                FrontendEnv[Environment Variables<br/>NEXT_PUBLIC_AGENT_CARD_URL<br/>NEXT_PUBLIC_API_BASE_URL<br/>NEXT_PUBLIC_DEFAULT_USER_ID]
            end
        end

        %% Cloud SQL
        subgraph CloudSQL["Cloud SQL for PostgreSQL"]
            SQLInstance[(Cloud SQL Instance<br/>PostgreSQL with pgvector)]
            SQLDatabase[(Database<br/>Catalog Items<br/>Cart Items<br/>Orders<br/>Payments<br/>Inquiries)]
        end

        %% Vertex AI Services
        subgraph VertexAI["Vertex AI (europe-west1)"]
            GeminiModel[Gemini 2.5 Flash<br/>LLM Inference]
            EmbeddingModel[Multimodal Embedding<br/>Text & Image Embeddings]
        end

        %% IAM & Security
        subgraph IAM["IAM & Security"]
            ServiceAccount[GitHub Actions<br/>Service Account]
            CloudRunSA[Cloud Run<br/>Service Account]
            IAMPolicies[IAM Policies<br/>roles/run.admin<br/>roles/artifactregistry.writer<br/>roles/iam.serviceAccountUser]
        end

        %% VPC & Networking
        subgraph Networking["Networking"]
            CloudSQLProxy[Cloud SQL Proxy<br/>Unix Socket Connection]
            LoadBalancer[Cloud Load Balancer<br/>HTTPS]
            CloudRunURLs[Cloud Run URLs<br/>*.run.app]
        end
    end

    %% Application Components (inside containers)
    subgraph BackendApp["Backend Application Components"]
        A2AProtocol[A2A Protocol Handler]
        AgentExecutor[ShoppingAgentExecutor]
        ADKRunner[ADK Runner]
        ShoppingAgent[Shopping Agent]
        SubAgents[Sub-Agents<br/>Product Discovery<br/>Cart<br/>Checkout<br/>Payment<br/>Customer Service]
        Tools[Agent Tools]
        SessionService[DatabaseSessionService]
    end

    subgraph FrontendApp["Frontend Application Components"]
        NextJSApp[Next.js Application]
        A2AClient[A2A Client SDK]
        Chatbox[Chatbox UI]
        ArtifactDisplay[Artifact Display]
    end

    %% Flow connections
    Users -->|HTTPS| LoadBalancer
    LoadBalancer -->|Routes| CloudRunURLs
    CloudRunURLs -->|HTTPS| FrontendService
    CloudRunURLs -->|HTTPS| BackendService

    GitHub -->|Push Events| GitHubActions
    GitHubActions -->|Triggers| BuildBackend
    GitHubActions -->|Triggers| BuildFrontend
    BuildBackend -->|Builds| BackendImage
    BuildFrontend -->|Builds| FrontendImage
    PushImages -->|Pushes| ARRepo
    ARRepo -->|Stores| BackendImage
    ARRepo -->|Stores| FrontendImage

    BackendImage -->|Deploys| BackendContainer
    FrontendImage -->|Deploys| FrontendContainer

    SecretManager -->|Provides Secrets| BackendSecrets
    ServiceAccount -->|Authenticates| GitHubActions
    CloudRunSA -->|Runs| BackendContainer
    CloudRunSA -->|Runs| FrontendContainer
    IAMPolicies -->|Grants Permissions| ServiceAccount

    BackendContainer -->|Contains| A2AProtocol
    A2AProtocol -->|Uses| AgentExecutor
    AgentExecutor -->|Uses| ADKRunner
    ADKRunner -->|Executes| ShoppingAgent
    ShoppingAgent -->|Delegates| SubAgents
    SubAgents -->|Calls| Tools
    ADKRunner -->|Uses| SessionService

    FrontendContainer -->|Contains| NextJSApp
    NextJSApp -->|Uses| A2AClient
    A2AClient -->|Displays| Chatbox
    A2AClient -->|Displays| ArtifactDisplay

    FrontendApp -->|A2A Protocol| BackendApp
    A2AClient -->|HTTP Requests| A2AProtocol

    BackendContainer -->|Connects via| CloudSQLProxy
    CloudSQLProxy -->|Unix Socket| SQLInstance
    SQLInstance -->|Stores Data| SQLDatabase
    SessionService -->|Persists Sessions| SQLDatabase
    Tools -->|Queries| SQLDatabase

    BackendContainer -->|API Calls| GeminiModel
    BackendContainer -->|API Calls| EmbeddingModel
    Tools -->|Generates Embeddings| EmbeddingModel
    ShoppingAgent -->|LLM Inference| GeminiModel
    SubAgents -->|LLM Inference| GeminiModel

    %% Styling
    classDef external fill:#e3f2fd,stroke:#1976d2,stroke-width:2px
    classDef cicd fill:#fff3e0,stroke:#f57c00,stroke-width:2px
    classDef gcp fill:#f1f8e9,stroke:#558b2f,stroke-width:2px
    classDef cloudrun fill:#fce4ec,stroke:#c2185b,stroke-width:2px
    classDef database fill:#e8eaf6,stroke:#3f51b5,stroke-width:2px
    classDef vertex fill:#fff9c4,stroke:#f9a825,stroke-width:2px
    classDef security fill:#ffebee,stroke:#d32f2f,stroke-width:2px
    classDef app fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px
    
    class Users,GitHub external
    class GitHubActions,BuildBackend,BuildFrontend,PushImages cicd
    class ARRepo,BackendImage,FrontendImage,SecretManager,APIKeySecret,DBPasswordSecret,DBNameSecret,DBUserSecret,CloudSQLSecret,LoadBalancer,CloudRunURLs,CloudSQLProxy gcp
    class BackendService,FrontendService,BackendContainer,FrontendContainer,BackendEnv,FrontendEnv,BackendSecrets cloudrun
    class SQLInstance,SQLDatabase database
    class GeminiModel,EmbeddingModel vertex
    class ServiceAccount,CloudRunSA,IAMPolicies security
    class A2AProtocol,AgentExecutor,ADKRunner,ShoppingAgent,SubAgents,Tools,SessionService,NextJSApp,A2AClient,Chatbox,ArtifactDisplay app
        </div>
    </div>

    <h2 id="cicd-flow">CI/CD Deployment Flow</h2>
    <div class="description">
        Automated deployment pipeline showing how code changes trigger builds and deployments to Cloud Run.
    </div>
    <div class="diagram-container">
        <div class="mermaid">
sequenceDiagram
    participant Dev as Developer
    participant GitHub as GitHub Repo
    participant Actions as GitHub Actions
    participant Docker as Docker Build
    participant AR as Artifact Registry
    participant CR as Cloud Run
    participant SM as Secret Manager
    participant DB as Cloud SQL

    Dev->>GitHub: Push code to main branch
    GitHub->>Actions: Trigger workflow (on push)
    
    Actions->>Actions: Check changed paths<br/>(backend/** or frontend/**)
    
    alt Backend Changes
        Actions->>Docker: Build backend image<br/>(Python 3.11 + FastAPI)
        Docker->>Docker: Install dependencies<br/>Copy application code
        Docker->>AR: Push image<br/>(cart-pilot-backend:{SHA})
        AR->>CR: Deploy to cart-pilot-backend
        CR->>SM: Fetch secrets<br/>(GOOGLE_API_KEY, DB_*)
        CR->>DB: Connect via Cloud SQL Proxy
        CR-->>Actions: Deployment successful
    end
    
    alt Frontend Changes
        Actions->>CR: Get backend service URL
        CR-->>Actions: Backend URL
        Actions->>Docker: Build frontend image<br/>(Next.js standalone)
        Docker->>Docker: Install dependencies<br/>Build Next.js app<br/>Set env vars
        Docker->>AR: Push image<br/>(cart-pilot-frontend:{SHA})
        AR->>CR: Deploy to cart-pilot-frontend
        CR-->>Actions: Deployment successful
    end
    
    Actions-->>GitHub: Update deployment status
    GitHub-->>Dev: Deployment complete
        </div>
    </div>

    <h2 id="request-flow">Request Flow Through Google Cloud</h2>
    <div class="description">
        Simplified request flow showing how services interact within Google Cloud Platform.
    </div>
    <div class="diagram-container">
        <div class="mermaid">
graph LR
    Frontend[Frontend Service<br/>Cloud Run<br/>Next.js]
    Backend[Backend Service<br/>Cloud Run<br/>FastAPI + ADK]
    SecretMgr[Secret Manager<br/>API Keys & DB Credentials]
    CloudSQL[Cloud SQL<br/>PostgreSQL + pgvector]
    VertexAI[Vertex AI<br/>Gemini & Embeddings]

    Frontend -->|A2A Protocol<br/>HTTP POST| Backend
    Backend -->|Fetch Secrets| SecretMgr
    SecretMgr -->|Return Credentials| Backend
    Backend -->|Unix Socket<br/>/cloudsql/connection-name| CloudSQL
    Backend -->|LLM API Calls| VertexAI
    Backend -->|Generate Embeddings| VertexAI
    VertexAI -->|Return Embeddings| Backend
    Backend -->|Vector Search| CloudSQL
    Backend -->|Query/Update<br/>Products, Cart, Orders| CloudSQL
    CloudSQL -->|Return Results| Backend
    Backend -->|Stream Response<br/>Text + Artifacts| Frontend

    %% Styling
    classDef frontend fill:#e1f5ff,stroke:#01579b,stroke-width:2px
    classDef backend fill:#fff3e0,stroke:#e65100,stroke-width:2px
    classDef database fill:#fce4ec,stroke:#880e4f,stroke-width:2px
    classDef vertex fill:#fff9c4,stroke:#f57f17,stroke-width:2px
    classDef secret fill:#e8f5e9,stroke:#1b5e20,stroke-width:2px
    
    class Frontend frontend
    class Backend backend
    class CloudSQL database
    class VertexAI vertex
    class SecretMgr secret
        </div>
    </div>

    <h2 id="application-architecture">Application Architecture</h2>
    <div class="description">
        Detailed application architecture showing agent hierarchy, tools, and data flow.
    </div>
    <div class="diagram-container">
        <div class="mermaid">
graph TB
    %% Frontend Layer
    subgraph Frontend["Frontend (Next.js)"]
        UI[User Interface]
        A2AClient[A2A Client SDK]
        Chatbox[Chatbox Component]
        ArtifactDisplay[Artifact Display Components]
    end

    %% API Gateway Layer
    subgraph Backend["Backend (Starlette/FastAPI)"]
        subgraph A2AProtocol["A2A Protocol Layer"]
            AgentCard[Agent Card Endpoint]
            RequestHandler[Default Request Handler]
            TaskStore[InMemory Task Store]
        end
        
        subgraph Executor["Agent Executor"]
            ShoppingExecutor[ShoppingAgentExecutor]
            MessageParser[Message Parser]
            ContentBuilder[Content Builder]
            SessionManager[Session Manager]
            StateTracker[State Tracker]
            ArtifactStreamer[Artifact Streamer]
            StatusHandler[Status Message Handler]
        end
        
        subgraph ADKCore["ADK Core Services"]
            Runner[ADK Runner]
            SessionService[DatabaseSessionService]
            ArtifactService[InMemoryArtifactService]
            MemoryService[InMemoryMemoryService]
        end
    end

    %% Agent Layer
    subgraph Agents["Agent Hierarchy"]
        RootAgent[Shopping Agent<br/>Root Orchestrator]
        
        subgraph SubAgents["Sub-Agents"]
            ProductAgent[Product Discovery Agent]
            CartAgent[Cart Agent]
            CheckoutAgent[Checkout Agent]
            CustomerAgent[Customer Service Agent]
            PaymentAgent[Payment Agent]
        end
    end

    %% Tools Layer
    subgraph Tools["Agent Tools"]
        subgraph ProductTools["Product Discovery Tools"]
            TextSearch[text_vector_search]
            ImageSearch[image_vector_search]
        end
        
        subgraph CartTools["Cart Tools"]
            AddToCart[add_to_cart]
            GetCart[get_cart]
            UpdateCart[update_cart_item]
            RemoveCart[remove_from_cart]
            ClearCart[clear_cart]
            CartTotal[get_cart_total]
        end
        
        subgraph CheckoutTools["Checkout Tools"]
            ValidateCart[validate_cart_for_checkout]
            CreateOrder[create_order]
            OrderStatus[get_order_status]
            CancelOrder[cancel_order]
        end
        
        subgraph PaymentTools["Payment Tools"]
            GetPaymentMethods[get_available_payment_methods]
            CreateCartMandate[create_cart_mandate]
            CreatePaymentMandate[create_payment_mandate]
            ProcessPayment[process_payment]
        end
        
        subgraph CustomerTools["Customer Service Tools"]
            CreateInquiry[create_inquiry]
            GetInquiryStatus[get_inquiry_status]
            SearchFAQ[search_faq]
            InitiateReturn[initiate_return]
        end
    end

    %% Database Layer
    subgraph Database["PostgreSQL Database"]
        subgraph Models["Data Models"]
            CatalogItems[CatalogItem<br/>with pgvector embeddings]
            CartItems[CartItem]
            Orders[Order]
            OrderItems[OrderItem]
            Mandates[Mandate]
            Payments[Payment]
            Inquiries[CustomerInquiry]
        end
        
        DBConnection[(PostgreSQL<br/>with pgvector)]
    end

    %% External Services
    subgraph External["External Services"]
        VertexAI[Vertex AI<br/>Gemini Model]
        EmbeddingService[Vertex AI<br/>Multimodal Embedding]
    end

    %% Flow connections
    UI -->|User Input| A2AClient
    A2AClient -->|A2A Protocol| AgentCard
    AgentCard --> RequestHandler
    RequestHandler --> ShoppingExecutor
    
    ShoppingExecutor --> MessageParser
    ShoppingExecutor --> ContentBuilder
    ShoppingExecutor --> SessionManager
    ShoppingExecutor --> StateTracker
    ShoppingExecutor --> ArtifactStreamer
    ShoppingExecutor --> StatusHandler
    ShoppingExecutor --> Runner
    
    Runner --> SessionService
    Runner --> ArtifactService
    Runner --> MemoryService
    Runner --> RootAgent
    
    RootAgent -->|Delegates| ProductAgent
    RootAgent -->|Delegates| CartAgent
    RootAgent -->|Delegates| CheckoutAgent
    RootAgent -->|Delegates| CustomerAgent
    RootAgent -->|Delegates| PaymentAgent
    
    ProductAgent --> TextSearch
    ProductAgent --> ImageSearch
    
    CartAgent --> AddToCart
    CartAgent --> GetCart
    CartAgent --> UpdateCart
    CartAgent --> RemoveCart
    CartAgent --> ClearCart
    CartAgent --> CartTotal
    
    CheckoutAgent --> ValidateCart
    CheckoutAgent --> CreateOrder
    CheckoutAgent --> OrderStatus
    CheckoutAgent --> CancelOrder
    
    PaymentAgent --> GetPaymentMethods
    PaymentAgent --> CreateCartMandate
    PaymentAgent --> CreatePaymentMandate
    PaymentAgent --> ProcessPayment
    
    CustomerAgent --> CreateInquiry
    CustomerAgent --> GetInquiryStatus
    CustomerAgent --> SearchFAQ
    CustomerAgent --> InitiateReturn
    
    TextSearch --> DBConnection
    ImageSearch --> DBConnection
    AddToCart --> DBConnection
    GetCart --> DBConnection
    UpdateCart --> DBConnection
    RemoveCart --> DBConnection
    ClearCart --> DBConnection
    CartTotal --> DBConnection
    ValidateCart --> DBConnection
    CreateOrder --> DBConnection
    OrderStatus --> DBConnection
    CancelOrder --> DBConnection
    CreateCartMandate --> DBConnection
    CreatePaymentMandate --> DBConnection
    ProcessPayment --> DBConnection
    CreateInquiry --> DBConnection
    GetInquiryStatus --> DBConnection
    SearchFAQ --> DBConnection
    InitiateReturn --> DBConnection
    
    DBConnection --> CatalogItems
    DBConnection --> CartItems
    DBConnection --> Orders
    DBConnection --> OrderItems
    DBConnection --> Mandates
    DBConnection --> Payments
    DBConnection --> Inquiries
    
    TextSearch --> EmbeddingService
    ImageSearch --> EmbeddingService
    
    RootAgent --> VertexAI
    ProductAgent --> VertexAI
    CartAgent --> VertexAI
    CheckoutAgent --> VertexAI
    CustomerAgent --> VertexAI
    PaymentAgent --> VertexAI
    
    SessionService -->|Persists State| DBConnection
    
    Runner -->|Streams Events| ArtifactStreamer
    ArtifactStreamer -->|A2A Events| RequestHandler
    RequestHandler -->|A2A Response| A2AClient
    A2AClient -->|Updates UI| Chatbox
    A2AClient -->|Displays Artifacts| ArtifactDisplay

    %% Styling
    classDef frontend fill:#e1f5ff,stroke:#01579b,stroke-width:2px
    classDef backend fill:#fff3e0,stroke:#e65100,stroke-width:2px
    classDef agent fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
    classDef tool fill:#e8f5e9,stroke:#1b5e20,stroke-width:2px
    classDef database fill:#fce4ec,stroke:#880e4f,stroke-width:2px
    classDef external fill:#fff9c4,stroke:#f57f17,stroke-width:2px
    
    class UI,A2AClient,Chatbox,ArtifactDisplay frontend
    class AgentCard,RequestHandler,TaskStore,ShoppingExecutor,MessageParser,ContentBuilder,SessionManager,StateTracker,ArtifactStreamer,StatusHandler,Runner,SessionService,ArtifactService,MemoryService backend
    class RootAgent,ProductAgent,CartAgent,CheckoutAgent,CustomerAgent,PaymentAgent agent
    class TextSearch,ImageSearch,AddToCart,GetCart,UpdateCart,RemoveCart,ClearCart,CartTotal,ValidateCart,CreateOrder,OrderStatus,CancelOrder,GetPaymentMethods,CreateCartMandate,CreatePaymentMandate,ProcessPayment,CreateInquiry,GetInquiryStatus,SearchFAQ,InitiateReturn tool
    class DBConnection,CatalogItems,CartItems,Orders,OrderItems,Mandates,Payments,Inquiries database
    class VertexAI,EmbeddingService external
        </div>
    </div>

    <h2 id="user-journey">User Journey Flow</h2>
    <div class="description">
        Complete user journey from product search to order placement, showing agent interactions and state management.
    </div>
    <div class="diagram-container">
        <div class="mermaid">
sequenceDiagram
    participant User
    participant Frontend
    participant A2AProtocol
    participant Executor
    participant ShoppingAgent
    participant SubAgent
    participant Tools
    participant Database
    participant VertexAI

    User->>Frontend: "Find me running shoes"
    Frontend->>A2AProtocol: A2A Request (text)
    A2AProtocol->>Executor: Parse & Create Session
    Executor->>ShoppingAgent: Execute with message
    
    ShoppingAgent->>ShoppingAgent: Analyze Intent
    ShoppingAgent->>SubAgent: Transfer to Product Discovery Agent
    
    SubAgent->>Tools: text_vector_search("running shoes")
    Tools->>Database: Query with embeddings
    Database-->>Tools: Product results
    Tools->>Database: Store in session state["current_results"]
    Tools-->>SubAgent: Return products
    SubAgent-->>ShoppingAgent: Product list
    ShoppingAgent-->>Executor: Response with products
    Executor->>A2AProtocol: Stream artifacts (products)
    A2AProtocol-->>Frontend: Display products
    
    User->>Frontend: "Add the blue ones"
    Frontend->>A2AProtocol: A2A Request
    A2AProtocol->>Executor: Get existing session
    Executor->>ShoppingAgent: Execute
    
    ShoppingAgent->>SubAgent: Transfer to Cart Agent
    SubAgent->>Tools: add_to_cart("blue ones")
    Tools->>Tools: Match "blue ones" from state["current_results"]
    Tools->>Database: Insert CartItem
    Tools->>Database: Update state["cart"]
    Tools-->>SubAgent: Cart updated
    SubAgent-->>ShoppingAgent: Cart confirmation
    ShoppingAgent-->>Executor: Response
    Executor->>A2AProtocol: Stream cart artifact
    A2AProtocol-->>Frontend: Display cart
    
    User->>Frontend: "Checkout"
    Frontend->>A2AProtocol: A2A Request
    A2AProtocol->>Executor: Execute
    Executor->>ShoppingAgent: Execute
    
    ShoppingAgent->>SubAgent: Transfer to Checkout Agent
    SubAgent->>Tools: validate_cart_for_checkout()
    Tools->>Database: Query cart
    Tools-->>SubAgent: Cart valid
    SubAgent->>Tools: Prepare order summary
    Tools->>Database: Update state["order_summary"]
    SubAgent-->>ShoppingAgent: Order summary
    ShoppingAgent-->>Executor: Show summary
    Executor-->>Frontend: Display order summary
    
    User->>Frontend: "Yes, confirm"
    Frontend->>A2AProtocol: A2A Request
    A2AProtocol->>Executor: Execute
    Executor->>ShoppingAgent: Execute
    
    ShoppingAgent->>SubAgent: Transfer to Payment Agent
    SubAgent->>Tools: get_available_payment_methods()
    Tools-->>SubAgent: Payment methods
    SubAgent-->>ShoppingAgent: Show payment options
    ShoppingAgent-->>Frontend: Display payment methods
    
    User->>Frontend: Select payment method + "place order"
    Frontend->>A2AProtocol: A2A Request
    A2AProtocol->>Executor: Execute
    Executor->>ShoppingAgent: Execute
    
    ShoppingAgent->>SubAgent: Transfer to Payment Agent
    SubAgent->>Tools: create_cart_mandate()
    SubAgent->>Tools: create_payment_mandate()
    SubAgent->>Tools: process_payment()
    Tools->>Database: Create Mandate & Payment records
    Tools->>Database: Update state["payment_processed"]
    Tools-->>SubAgent: Payment successful
    SubAgent-->>ShoppingAgent: "Payment processed successfully"
    
    Note over ShoppingAgent: Automatic continuation<br/>No user input needed
    ShoppingAgent->>SubAgent: Transfer to Checkout Agent (immediate)
    SubAgent->>Tools: create_order()
    Tools->>Database: Create Order & OrderItems
    Tools->>Database: Clear cart
    Tools-->>SubAgent: Order created
    SubAgent-->>ShoppingAgent: Order confirmation
    ShoppingAgent-->>Executor: Complete response
    Executor-->>Frontend: Order confirmation
    Frontend-->>User: "Your order has been placed!"
        </div>
    </div>

    <div style="margin-top: 50px; padding: 20px; background: #e8f5e9; border-radius: 8px; text-align: center;">
        <p><strong>üìä Diagrams Generated Successfully!</strong></p>
        <p>All architecture diagrams are rendered above. You can also view them in:</p>
        <ul style="list-style: none; padding: 0;">
            <li>‚úÖ GitHub (native Mermaid support)</li>
            <li>‚úÖ <a href="https://mermaid.live" target="_blank">Mermaid Live Editor</a></li>
            <li>‚úÖ VS Code with Mermaid extension</li>
            <li>‚úÖ This HTML file (open in browser)</li>
        </ul>
    </div>
</body>
</html>

